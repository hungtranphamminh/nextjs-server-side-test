# CryptoGuard Workflow Setup - Complete

## Summary

GitHub Actions workflow has been created for automatic CryptoGuard deployment with manifest support.

## Files Created

1. **`.github/workflows/cryptoguard-deploy.yml`** - Main workflow file
2. **`.github/SETUP.md`** - Detailed setup instructions
3. **`.gitignore`** - Updated to ignore `.vercel/` directory

## Key Changes from Old Workflow

### Old Workflow (v0.3.9)
- Used `npm` package manager
- No manifest support
- Domain hardcoded in workflow
- Build directory: `./dist`

### New Workflow (v0.4.0)
- Uses `pnpm` package manager
- **Manifest support enabled** (auto-generated by `@cmdoss/cryptoguard-manifest-nextjs`)
- Domain stored in **GitHub Secrets** (`${{ secrets.DOMAIN }}`)
- Build directory: `./.next` (Next.js standard)
- **Additional step**: Copies `manifest.json` to build directory
- Optional Vercel deployment integration (commented out)

## Workflow Steps

```yaml
1. Checkout code
2. Setup pnpm (v9)
3. Setup Node.js (v20 with pnpm cache)
4. Install dependencies (pnpm install)
5. Build application (pnpm build)
   ‚Üí Generates manifest.json automatically
6. Prepare Manifest
   ‚Üí Copies manifest.json to .next/manifest.json
7. CryptoGuard Deploy (v0.4.0)
   ‚Üí Validates manifest
   ‚Üí Generates SLSA provenance
   ‚Üí Uploads 3 blobs to Walrus (content, provenance, manifest)
   ‚Üí Creates metadata quilt
   ‚Üí Updates Sui blockchain
```

## Required Secrets

You need to add these secrets in GitHub repository settings:

### 1. DOMAIN
- **Name**: `DOMAIN`
- **Value**: `nei.qingyun-kong.com`
- **Location**: Settings ‚Üí Secrets and variables ‚Üí Actions

### 2. PRIVATE_KEY
- **Name**: `PRIVATE_KEY`
- **Value**: Your 64-character Ed25519 private key (hex, no `0x` prefix)
- **Location**: Settings ‚Üí Secrets and variables ‚Üí Actions
- **‚ö†Ô∏è SECURITY**: Never commit or share this key

## How to Add Secrets

```bash
# Navigate to your GitHub repository
# https://github.com/YOUR_USERNAME/YOUR_REPO/settings/secrets/actions

1. Click "New repository secret"
2. Name: DOMAIN
   Value: nei.qingyun-kong.com
3. Click "Add secret"

4. Click "New repository secret"
5. Name: PRIVATE_KEY
   Value: <your-64-char-hex-private-key>
6. Click "Add secret"
```

## Manifest Integration

The workflow automatically uses the manifest generated by your Next.js build:

**Generated at build time** (`pnpm build`):
```json
{
  "version": "1.0",
  "framework": "nextjs",
  "frameworkVersion": "15.5.4",
  "sources": [
    {
      "dir": ".next/static",
      "serveAt": "/_next/static"
    },
    {
      "dir": "public",
      "serveAt": "/"
    }
  ]
}
```

**Location after "Prepare Manifest" step**:
- Root: `manifest.json` (generated by plugin)
- Build dir: `.next/manifest.json` (copied for action)

## Testing the Workflow

### Option 1: Manual Trigger
1. Go to **Actions** tab
2. Select **CryptoGuard Deploy with Manifest**
3. Click **Run workflow**
4. Select `main` branch
5. Click **Run workflow**

### Option 2: Push to Main
```bash
git add .
git commit -m "feat: add CryptoGuard workflow with manifest"
git push origin main
```

## Expected Output

When the workflow runs successfully:

```
‚úì Checkout code
‚úì Setup pnpm
‚úì Setup Node.js
‚úì Install dependencies
‚úì Build
  üîß CryptoGuard: Generating manifest for Next.js...
  ‚úÖ CryptoGuard: Manifest generation complete
‚úì Prepare Manifest
‚úì CryptoGuard Deploy
  Step 4.5: Detect and Validate Manifest
    Found manifest.json, validating...
  ‚úì Manifest validated: nextjs v15.5.4
    Sources: 2 directory mappings

  Step 5: Upload to Walrus
  ‚úì Uploaded 4 blobs:
    Content: 0xabc123...
    Provenance: 0xdef456...
    Manifest: 0xghi789... (nextjs)
    Metadata: 0xjkl012...

  Step 6: Update Sui Domain Registry
  ‚úì Domain updated successfully
```

## Blob Structure

The workflow creates 4 blobs on Walrus:

1. **Content Quilt** (blob1)
   - Contains all application files with their blob IDs
   - Links to individual file blobs

2. **Provenance** (blob2)
   - SLSA attestation with GitHub OIDC
   - Build metadata and source repository info

3. **Manifest** (blob3) ‚Üê **NEW in v0.4.0**
   - Framework routing information
   - Directory mappings for serving files

4. **Metadata Quilt** (blob4)
   - Links to blobs 1, 2, 3
   - Contains framework metadata:
     - `manifest_blob_id`
     - `framework: "nextjs"`
     - `framework_version: "15.5.4"`

## Vercel Integration (Optional)

If you want to deploy to Vercel before CryptoGuard attestation:

1. Uncomment the "Deploy to Vercel" step in workflow
2. Add these secrets:
   - `VERCEL_TOKEN`
   - `VERCEL_ORG_ID`
   - `VERCEL_PROJECT_ID`

See `.github/SETUP.md` for detailed instructions.

## Troubleshooting

### Common Issues

**Build fails with React error:**
- Solution: Use React 19.0.0 (not 19.1.0)
- Check: `package.json` should have `"react": "19.0.0"`

**Manifest not found:**
- Solution: Check "Prepare Manifest" step succeeded
- Verify: `manifest.json` exists in root after build

**Domain update fails:**
- Solution: Verify `PRIVATE_KEY` secret is correct
- Check: Key is 64 hex characters without `0x` prefix
- Verify: Domain is registered with this key's address

**Permission denied:**
- Solution: Check workflow permissions
- Required: `id-token: write`, `contents: read`, `actions: read`, `attestations: write`

## Next Steps

1. **Add secrets**: Add `DOMAIN` and `PRIVATE_KEY` to GitHub Secrets
2. **Commit workflow**: Push `.github/workflows/` to repository
3. **Test**: Trigger workflow manually or push to main
4. **Verify**: Check Actions tab for deployment progress
5. **Validate**: Confirm all 4 blobs uploaded and domain updated

## Documentation

- **Setup Guide**: `.github/SETUP.md`
- **Architecture**: `/whole-system-documents/newest-architecture.md`
- **Manifest Integration**: `/packages/action/MANIFEST-INTEGRATION-COMPLETE.md`

---

**Last Updated**: December 19, 2025
**Workflow Version**: v0.4.0
**Status**: Ready for deployment

# CryptoGuard SLSA Level 3 Deploy
# Uses 3-job pattern for real SLSA Level 3 provenance

name: CryptoGuard SLSA Level 3 Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

# Required permissions for SLSA Level 3 provenance
permissions:
  actions: read
  contents: write
  id-token: write

jobs:
  # Job 1: Build (uses CryptoGuard build workflow)
  build:
    uses: CommandOSSLabs/cryptoguard-action/.github/workflows/build.yml@v1
    with:
      build-command: "pnpm build"
      build-dir: ".next"
      manifest-path: "./manifest.json"
      package-manager: "pnpm"
      node-version: "20"

  # Job 2: Provenance (SLSA Level 3 - runs on isolated VM)
  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: false

  # Job 3: Deploy (uses CryptoGuard deploy workflow)
  deploy:
    needs: [build, provenance]
    uses: CommandOSSLabs/cryptoguard-action/.github/workflows/deploy.yml@v1
    with:
      provenance-name: "${{ needs.provenance.outputs.provenance-name }}"
      network: "testnet"
    secrets:
      DOMAIN: ${{ secrets.DOMAIN }}
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

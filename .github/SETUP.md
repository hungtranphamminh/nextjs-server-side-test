# GitHub Action Setup Guide

This guide explains how to set up GitHub Secrets for the CryptoGuard deployment workflow.

## Required Secrets

You need to add the following secrets to your GitHub repository:

### 1. DOMAIN
Your domain name for the deployment.

**Value:** `nei.qingyun-kong.com`

**How to add:**
1. Go to your GitHub repository
2. Navigate to **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Name: `DOMAIN`
5. Value: `nei.qingyun-kong.com`
6. Click **Add secret**

### 2. PRIVATE_KEY
Your Sui blockchain private key (Ed25519 format).

**Format:** 64-character hexadecimal string (without `0x` prefix)

**Example:** `abc123def456...` (64 hex characters)

**⚠️ Security Warning:**
- NEVER commit your private key to the repository
- NEVER share your private key with anyone
- This key controls your domain ownership on the blockchain

**How to add:**
1. Go to your GitHub repository
2. Navigate to **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Name: `PRIVATE_KEY`
5. Value: Your 64-character Ed25519 private key
6. Click **Add secret**

**How to get your private key:**
```bash
# If using Sui CLI
sui keytool export --key-identity <your-address>

# Output format: suiprivkey... (convert to hex if needed)
```

## Optional: Vercel Deployment

If you want to automatically deploy to Vercel before CryptoGuard attestation:

### 3. VERCEL_TOKEN
Your Vercel API token.

**How to get:**
1. Go to https://vercel.com/account/tokens
2. Click **Create Token**
3. Copy the token

### 4. VERCEL_ORG_ID
Your Vercel organization ID.

**How to get:**
```bash
# Install Vercel CLI
npm i -g vercel

# Link your project
vercel link

# Check .vercel/project.json for orgId
cat .vercel/project.json
```

### 5. VERCEL_PROJECT_ID
Your Vercel project ID.

**How to get:**
Same as above - check `.vercel/project.json` for `projectId`

## Workflow Configuration

The workflow is located at `.github/workflows/cryptoguard-deploy.yml`

### Current Configuration

```yaml
domain: ${{ secrets.DOMAIN }}           # nei.qingyun-kong.com
debug: true                              # Enable verbose logging
build-dir: ./.next                       # Next.js build output
network: testnet                         # Sui Testnet
registry-id: "0x7d7d100cce0cbbd01625b7f250c14cf25080fdcc412c651054ce44fe13f79bea"
package-id: "0xddba6e2954145327888ca39d4875b858622023175869d63b06e2d2ff7cc49310"
```

### What Happens During Build

1. **Install Dependencies**: `pnpm install`
2. **Build Application**: `pnpm build`
   - Next.js builds to `.next/`
   - CryptoGuard manifest plugin generates `manifest.json` in root
3. **Prepare Manifest**: Copies `manifest.json` to `.next/manifest.json`
4. **CryptoGuard Deploy**:
   - Scans `.next/` directory
   - Validates `manifest.json` format
   - Generates SLSA provenance attestation
   - Uploads to Walrus storage (3 blobs: content-quilt, provenance, manifest)
   - Creates metadata quilt linking all blobs
   - Updates domain record on Sui blockchain with signature

### Manifest Content

The manifest is automatically generated by `@cmdoss/cryptoguard-manifest-nextjs`:

```json
{
  "version": "1.0",
  "framework": "nextjs",
  "frameworkVersion": "15.5.4",
  "sources": [
    {
      "dir": ".next/static",
      "serveAt": "/_next/static"
    },
    {
      "dir": "public",
      "serveAt": "/"
    }
  ]
}
```

## Testing the Workflow

### Manual Trigger
1. Go to **Actions** tab in your repository
2. Click **CryptoGuard Deploy with Manifest**
3. Click **Run workflow**
4. Select branch (usually `main`)
5. Click **Run workflow**

### Automatic Trigger
The workflow automatically runs on every push to `main` branch.

## Troubleshooting

### Build Fails: "Cannot read properties of null (reading 'useRef')"
- **Solution**: Make sure you're using React 19.0.0 (not 19.1.0)
- Check `package.json`: `"react": "19.0.0"`

### "Invalid manifest.json format"
- **Check**: Manifest must have `version`, `framework`, `frameworkVersion`, `sources`
- **Verify**: Run `cat manifest.json` to check format
- **Rebuild**: Run `pnpm build` locally to regenerate

### "Manifest blob not found in metadata quilt"
- **Ensure**: Manifest was copied to build directory
- **Check workflow**: "Prepare Manifest" step should succeed

### Domain Update Fails
- **Verify**: PRIVATE_KEY secret is correct (64 hex characters)
- **Check**: Domain is registered with this private key's address
- **Network**: Make sure you're using the correct network (testnet/mainnet)

## Next Steps

After setting up secrets:

1. **Commit workflow**: `git add .github/ && git commit -m "feat: add CryptoGuard deployment workflow"`
2. **Push to main**: `git push origin main`
3. **Monitor deployment**: Check Actions tab for deployment progress
4. **Verify deployment**: Check that all 4 blobs were uploaded (content, provenance, manifest, metadata)

## Support

For issues or questions:
- GitHub Issues: https://github.com/CommandOSSLabs/binary-transparency/issues
- Documentation: See `/whole-system-documents/newest-architecture.md`
